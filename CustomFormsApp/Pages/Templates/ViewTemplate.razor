@page "/templates/view/{TemplateId:int}"
@using CustomFormsApp.Data.Models
@using CustomFormsApp.Data.Enums 
@using CustomFormsApp.Services
@using CustomFormsApp.Components.Likes
@using CustomFormsApp.Components.Comments 
@inject ITemplateService TemplateService
@inject NavigationManager Navigation
@inject ILogger<ViewTemplate> Logger
@inject ICurrentUserService CurrentUserService

<PageTitle>View Template: @(template?.Title ?? "Loading...")</PageTitle>

<div class="container mt-4">
    @if (isLoading)
    {
        <div class="text-center my-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading template...</span>
            </div>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> @errorMessage
        </div>
        <button class="btn btn-secondary" @onclick='() => Navigation.NavigateTo("/templates")'> @* Corrected quotes *@
             <i class="bi bi-arrow-left"></i> Back to Templates
        </button>
    }
    else if (template == null)
    {
        <div class="alert alert-warning" role="alert">
            Template not found or you may not have permission to view it.
        </div>
         <button class="btn btn-secondary" @onclick='() => Navigation.NavigateTo("/templates")'> @* Corrected quotes *@
             <i class="bi bi-arrow-left"></i> Back to Templates
        </button>
    }
    else
    {
        @* --- Template Details Card --- *@
        <div class="card shadow-sm mb-4">
            <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                <h2 class="mb-0 me-3">@template.Title</h2>
                <div class="d-flex align-items-center gap-2">
                    <LikeButton TemplateId="@template.Id" />
                    <button class="btn btn-primary" @onclick="UseTemplate" title="Create a form based on this template">
                        <i class="bi bi-plus-square me-1"></i> Use Template
                    </button>
                    @* Show Edit button only if the current user owns the template *@
                    @if (IsOwner())
                    {
                        <button class="btn btn-outline-secondary" @onclick="EditTemplate" title="Edit this template">
                            <i class="bi bi-pencil-square me-1"></i> Edit
                        </button>
                    }
                </div>
            </div>
            <div class="card-body">
                @if (!string.IsNullOrWhiteSpace(template.Description))
                {
                    <p class="card-text">@template.Description</p>
                }
                else
                {
                    <p class="card-text text-muted"><i>No description provided.</i></p>
                }

                <div class="row mb-3 small text-muted">
                    <div class="col-md-6">
                        <strong>Author:</strong> @(template.CreatedBy?.Username ?? "Unknown")
                    </div>
                    <div class="col-md-6">
                        <strong>Topic:</strong> @(template.Topic ?? "N/A")
                    </div>
                </div>
                 <div class="row small text-muted">
                    <div class="col-md-6">
                        <strong>Created:</strong> @template.CreatedDate.ToLocalTime().ToString("g")
                    </div>
                    <div class="col-md-6">
                        <strong>Last Updated:</strong> @(template.LastModifiedDate?.ToLocalTime().ToString("g") ?? "N/A")
                    </div>
                </div>
                @* TODO: Display Tags if they exist *@
                @if (template.TemplateTags != null && template.TemplateTags.Any())
                {
                    <div class="mt-3">
                        <strong>Tags:</strong>
                        @foreach (var tag in template.Tags)
                        {
                            <span class="badge bg-secondary me-1">@tag.Name</span>
                        }
                    </div>
                }
            </div>
        </div>

        @* --- Template Questions Section --- *@
        <h3 class="mt-5 mb-3">Template Questions</h3>
        @if (template.Questions == null || !template.Questions.Any())
        {
            <p class="text-muted">This template has no questions defined.</p>
        }
        else
        {
            <div class="list-group mb-5">
                @foreach (var question in template.Questions.OrderBy(q => q.Order))
                {
                    <div class="list-group-item list-group-item-action flex-column align-items-start">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">@question.Order. @question.Text @(question.IsRequired ? "*" : "")</h5>
                            <small class="text-muted">Type: @question.Type</small>
                        </div>
                        @if (!string.IsNullOrWhiteSpace(question.Description))
                        {
                            <p class="mb-1 text-muted small">@question.Description</p>
                        }
                        @* Display options for relevant types *@
                        @if ((question.Type == QuestionType.Checkbox || question.Type == QuestionType.MultipleChoice || question.Type == QuestionType.Dropdown) && question.Options != null && question.Options.Any())
                        {
                            <div class="mt-2">
                                <small><strong>Options:</strong></small>
                                <ul class="list-unstyled small ms-3">
                                    @foreach (var option in string.Join('\n', question.Options).Split(new[] { '\n', ',' }, StringSplitOptions.RemoveEmptyEntries))
                                    {
                                        <li>- @option.Trim()</li>
                                    }
                                </ul>
                            </div>
                        }
                    </div>
                }
            </div>
        }

        @* --- Comments Section --- *@
        <div class="comments-section mt-5 pt-4 border-top">
            <h3 class="mb-3">Comments</h3>
            @* Render the comment list, passing the TemplateId *@
            <CommentList @ref="commentListRef" TemplateId="@TemplateId" />

            @* Render the comment input, passing TemplateId and wiring up the event *@
            <CommentInput TemplateId="@TemplateId" OnCommentAdded="HandleCommentAdded" />
        </div>
    }
</div>

@code {
    [Parameter]
    public int TemplateId { get; set; }

    private Template? template;
    private bool isLoading = true;
    private string? errorMessage;
    private string? currentUserId;

    // Reference to the CommentList component
    private CommentList? commentListRef;

    protected override async Task OnParametersSetAsync()
    {
        isLoading = true;
        errorMessage = null;
        template = null;
        currentUserId = CurrentUserService.GetUserId(); // Get current user ID

        if (TemplateId <= 0)
        {
            errorMessage = "Invalid Template ID.";
            isLoading = false;
            return;
        }

        try
        {
            // Fetch template including related data needed for display
            template = await TemplateService.GetTemplateAsync(TemplateId);

            if (template == null)
            {
                errorMessage = "Template not found or you may not have permission to view it.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading template with ID {TemplateId}", TemplateId);
            errorMessage = "An error occurred while loading the template details.";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void UseTemplate()
    {
        // Navigate to the form builder, passing the template ID to pre-fill
        Navigation.NavigateTo($"/form-builder?templateId={TemplateId}");
    }

    private void EditTemplate()
    {
        // Navigate to the form builder in edit mode
        Navigation.NavigateTo($"/form-builder/{TemplateId}?mode=template");
    }

    private bool IsOwner()
    {
        // Check if the current user is the creator of the template OR an admin
        bool isCreator = !string.IsNullOrEmpty(currentUserId) && template?.CreatedById == currentUserId;
        bool isAdmin = CurrentUserService.IsAdmin();
        
        return isCreator || isAdmin;
    }

    // Method to handle the event emitted by CommentInput when a comment is added
    private async Task HandleCommentAdded()
    {
        if (commentListRef != null)
        {
            Logger.LogInformation("New comment added for Template {TemplateId}, refreshing list.", TemplateId);
            await commentListRef.LoadComments(); // Call the public method on CommentList to refresh
        }
        else
        {
             Logger.LogWarning("commentListRef is null in HandleCommentAdded for Template {TemplateId}.", TemplateId);
        }
    }
}